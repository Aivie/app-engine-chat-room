<html>
  <head>
    <!-- Imports goog.appengine.Channel. -->
    <script src='/_ah/channel/jsapi'></script>

    <style type='text/css'>
      body, input {
        font-family: 'Helvetica';
        font-size: 20px;
        font-weight: bold;
      }

      #chat {
        width: 100%;
        position: absolute;
        bottom: 0px;
      }

      #newmessage, #newmessage:focus {
        width: 100%;
        padding: 5px;
        border: none;
        outline: none;
        outline-offset: 0px;
      }
    </style>
  </head>
  <body>
    <div id='chat'>
      <div id='messages'></div>
      <input disabled placeholder='Connecting...' id='newmessage'></input>
    </div>

    <script type='text/javascript'>
      var messages = document.getElementById('messages');
      var newmessage = document.getElementById('newmessage');

      // Wire up the channel event handlers.
      var channel = new goog.appengine.Channel('{{ token }}');
      var handler = {
        'onopen': function() {
          // Let the chatting begin.
          newmessage.placeholder = "Send a message";
          newmessage.disabled = false;
          newmessage.focus();
        },
        'onmessage': function(m) {
          // Blindly append the message to the end of the element.
          messages.innerHTML += '<p>' + m.data + '</p>';
        },
        'onerror': function() {}, // No-op.
        'onclose': function() {}, // No-op.
      };
      channel.open(handler);

      // Enter-button handler, i.e. send a message.
      newmessage.onkeypress = function(e) {
        if (e.key === 'Enter' && newmessage.value !== '') {
          var path = '/send?data=' + encodeURI(newmessage.value);
          var xhr = new XMLHttpRequest();
          xhr.open('POST', path, true);
          xhr.send();
          newmessage.value = '';
        }
      };

      // Force all focus to the input box.
      newmessage.onblur = function(e) {
        newmessage.focus();
      };

    </script>
  </body>
</html>
